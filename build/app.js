(()=>{"use strict";var e;function t(e){const t="dhsc".indexOf(e.suit);return 4*"3456789TJQKA2".indexOf(e.rank)+t}function s(e){return`${e.rank}${{d:"♦",c:"♣",h:"♥",s:"♠"}[e.suit]}`}function a(e,t){if(0===e.length)return function(e){const t=document.createElement("div");return t.classList.add("pass-move"),t.classList.add(e),t.innerHTML="Pass",t}(t);const a=document.createElement("div");return a.classList.add("hand-container"),e.forEach((e=>{a.appendChild(function(e,t){const a=document.createElement("div");return a.classList.add("card"),a.classList.add(`card-${t}`),"d"===e.suit||"h"===e.suit?a.classList.add("red"):a.classList.add("black"),a.innerHTML=s(e),a}(e,t))})),a}function n(e,t){const a=document.createElement("div");return a.classList.add("player-state"),a.appendChild(function(e){const t=document.createElement("div");return t.classList.add("player-status"),t.appendChild(function(e){const t=document.createElement("span");return t.textContent=e,t}(e.playerId)),t.appendChild(function(e){const t=document.createElement("span");return t.textContent=`${e} pts`,t}(e.numPoints)),t}(e)),void 0!==e.cards?a.appendChild(function(e,t){const a=document.createElement("div");return a.classList.add("hand-container"),e.forEach((e=>{a.appendChild(function(e,t){const a=document.createElement("div");for(const t of function*(e){yield"card",yield"card-front","d"===e.suit||"h"===e.suit?yield"red":yield"black",e.isSelected&&(yield"selected")}(e))a.classList.add(t);return a.innerHTML=s(e),a.onclick=()=>{t.update((t=>{const s=function(e,t){return t.some((t=>t.rank===e.rank&&t.suit===e.suit))?t.filter((t=>t.rank!==e.rank||t.suit!==e.suit)):[...t,e]}(e,t.selectedCards||[]);return Object.assign(Object.assign({},t),{selectedCards:s})}))},a.ondblclick=()=>{t.update((e=>Object.assign(Object.assign({},e),{selectedCards:[]})))},a}(e,t))})),a}(e.cards,t)):a.appendChild(function(e){const t=document.createElement("div");return t.classList.add("hand-container"),t.innerHTML=`<div class="card card-back">${e}</div>`,t}(e.numCards)),a}function r(e,t){return e.findIndex((e=>e.rank===t.rank&&e.suit===t.suit))}function i(e){return Array.isArray(e)?e.map(i):e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map((([e,t])=>[e.replace(/([A-Z])/g,"_$1").toLowerCase(),i(t)]))):e}function d(e){return Array.isArray(e)?e.map(d):e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map((([e,t])=>[e.replace(/_([a-z])/g,((e,t)=>t.toUpperCase())),d(t)]))):e}!function(e){e.START_GAME="START_GAME",e.START_MATCH="START_MATCH",e.DEAL_CARDS="DEAL_CARDS",e.START_ROUND="START_ROUND",e.START_TURN="START_TURN",e.AWAIT_PLAYER_ACTION="AWAIT_PLAYER_ACTION",e.END_TURN="END_TURN",e.END_ROUND="END_ROUND",e.END_MATCH="END_MATCH",e.UPDATE_POINTS="UPDATE_POINTS",e.END_GAME="END_GAME"}(e||(e={}));const o=new class{constructor(){this.state={},this.subscribers=[]}subscribe(e){this.subscribers.push(e),e.update(this.state)}update(e){this.state=e(this.state),this.subscribers.forEach((e=>e.update(this.state)))}getState(){return this.state}},c=new class{constructor(e){this.stateStore=e}handle(e){if("ERROR"===e.messageType)this.handleErrorMessage(e.payload);else if("PLAYER_JOINED"===e.messageType)this.handlePlayerJoined(e.payload);else if("GAME_STATE"===e.messageType)if(e.payload.sharedView){const t=e.payload;this.handleSharedGameState(t.sharedView)}else if(e.payload.privateView){const t=e.payload;this.handlePrivateGameState(t.privateView)}}handlePlayerJoined(e){const t=`Players in room: ${e.playerIds.join(", ")}`;this.stateStore.update((s=>Object.assign(Object.assign({},s),{alertMsg:t,roomId:e.roomId})))}handleErrorMessage(e){this.stateStore.update((t=>Object.assign(Object.assign({},t),{alertMsg:`Error: ${e.error}`,selectedCards:[]})))}handleSharedGameState(e){var t;let s;e.result&&(s=`Game over. Results: ${null===(t=e.result)||void 0===t?void 0:t.players.map((e=>`${e.playerId}: ${e.distToAvg}`)).join(" / ")}`);const a="UPDATE_POINTS"==e.status?[]:this.stateStore.getState().myCards;this.stateStore.update((t=>Object.assign(Object.assign({},t),{sharedGameState:e,alertMsg:s,myCards:a})))}handlePrivateGameState(e){const t=e.cards,s=this.stateStore.getState().myCards||[],a=t.sort(((e,t)=>r(s,e)-r(s,t)));this.stateStore.update((e=>Object.assign(Object.assign({},e),{myCards:a,alertMsg:void 0,selectedCards:[]})))}}(o),l=new class{onMessage(e){this.callbackOnMessage=e}send(e){var t;null===(t=this.ws)||void 0===t||t.send(JSON.stringify(i(e)))}connect(e){try{this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("Socket connected")},this.ws.onmessage=e=>{var t;null===(t=this.callbackOnMessage)||void 0===t||t.call(this,d(JSON.parse(e.data)))},this.ws.onclose=()=>{console.log("Socket closed")},this.ws.onerror=e=>{console.log(`Socket error: ${e}`)}}catch(e){console.log(`Socket error: ${e}`)}}},u=prompt("Enter server URL","ws://localhost:8765");l.connect(u),l.onMessage((e=>{c.handle(e)}));const h=new class{constructor(e,t){this.socketService=e,this.stateStore=t}joinGame(){this.socketService.send({playerId:this.stateStore.getState().playerId,requestType:"JOIN_GAME_BY_TYPE",payload:{gameType:"chinese_poker"}})}makeMove(e){const{playerId:t,roomId:s}=this.stateStore.getState();this.socketService.send({playerId:t,requestType:"MAKE_MOVE",payload:{roomId:s,move:{cards:e}}})}}(l,o),p=new class{constructor(e){var t;this.stateStore=e,this.authBtn=document.getElementById("auth-btn"),this.playerIdSpan=document.getElementById("player-id"),null===(t=this.authBtn)||void 0===t||t.addEventListener("click",this.onAuthBtnClick.bind(this))}update(e){this.playerIdSpan&&(this.playerIdSpan.innerText=e.playerId?e.playerId:""),this.authBtn&&(this.authBtn.innerText=e.playerId?"Logout":"Login")}onAuthBtnClick(){if(this.stateStore.getState().playerId)this.stateStore.update((e=>Object.assign(Object.assign({},e),{playerId:""})));else{const e=prompt("Enter your player ID");e&&this.stateStore.update((t=>Object.assign(Object.assign({},t),{playerId:e})))}}}(o);o.subscribe(p);const m=new class{constructor(e){var t;this.gameService=e,this.joinBtn=document.getElementById("join-btn"),null===(t=this.joinBtn)||void 0===t||t.addEventListener("click",this.onJoinBtnClick.bind(this))}onJoinBtnClick(){this.gameService.joinGame()}update(e){var t,s,a;e.playerId&&!e.roomId||"END_GAME"===(null===(t=e.sharedGameState)||void 0===t?void 0:t.status)?null===(s=this.joinBtn)||void 0===s||s.classList.remove("hidden"):null===(a=this.joinBtn)||void 0===a||a.classList.add("hidden")}}(h);o.subscribe(m);const v=new class{constructor(){this.alertMsgSpan=document.getElementById("alert-msg")}update(e){this.alertMsgSpan&&(this.alertMsgSpan.textContent=e.alertMsg?e.alertMsg:"")}};o.subscribe(v);const y=new class{constructor(e){this.stateStore=e,this.table=document.getElementById("table")}reset(){for(var e;null===(e=this.table)||void 0===e?void 0:e.firstChild;)this.table.removeChild(this.table.firstChild)}cardsUI(e,t){if(0===e&&void 0!==t.myCards)return void 0===t.selectedCards?t.myCards.map((e=>Object.assign(Object.assign({},e),{isSelected:!1}))):t.myCards.map((e=>Object.assign(Object.assign({},e),{isSelected:t.selectedCards.some((t=>t.rank===e.rank&&t.suit===e.suit))})))}playerDiv(e,t,s){var r,i;const d=this.cardsUI(t,s),o=(null===(r=s.sharedGameState)||void 0===r?void 0:r.currentPlayerId)===e.playerId,c=(null===(i=s.sharedGameState)||void 0===i?void 0:i.moveHistory.filter((t=>t.playerId===e.playerId)))||[];return function(e,t){const s=document.createElement("div"),r=function(e){if(0===e)return"bottom";if(1===e)return"left";if(2===e)return"top";if(3===e)return"right";throw new Error(`Invalid offset: ${e}`)}(e.offset);return s.classList.add("player"),s.classList.add(r),s.appendChild(n(e,t)),e.moveHistory.length>0&&s.appendChild(function(e){const t=document.createElement("div");if(t.classList.add("move-history"),e.length>1){const s=e[e.length-2];t.appendChild(a(s,"micro"))}if(e.length>0){const s=e[e.length-1];t.appendChild(a(s,"mini"))}return t}(e.moveHistory)),e.isTheirTurn&&s.appendChild(function(){const e=document.createElement("div");return e.classList.add("dealer-token"),e}()),s}(Object.assign(Object.assign({},e),{offset:t,cards:d,isTheirTurn:o,moveHistory:c.map((e=>e.cards))}),this.stateStore)}update(e){var t;this.reset();const s=null===(t=e.sharedGameState)||void 0===t?void 0:t.players;if(s){const t=s.findIndex((t=>t.playerId===e.playerId));s.forEach(((a,n)=>{var r;const i=(n-t+s.length)%s.length;null===(r=this.table)||void 0===r||r.appendChild(this.playerDiv(a,i,e))}))}}}(o);o.subscribe(y);const g=new class{constructor(e,t){var s,a,n;this.stateStore=e,this.gameService=t,this.makeMoveBtn=document.getElementById("make-move-btn"),this.passBtn=document.getElementById("pass-btn"),this.sortCardsBtn=document.getElementById("sort-cards-btn"),null===(s=this.makeMoveBtn)||void 0===s||s.addEventListener("click",(()=>this.gameService.makeMove(e.getState().selectedCards||[]))),null===(a=this.passBtn)||void 0===a||a.addEventListener("click",(()=>this.gameService.makeMove([]))),null===(n=this.sortCardsBtn)||void 0===n||n.addEventListener("click",this.onSortCardsBtnClick.bind(this))}onSortCardsBtnClick(){this.stateStore.update((e=>{var s;const a=null===(s=e.myCards)||void 0===s?void 0:s.slice().sort(((e,s)=>t(e)-t(s)));return Object.assign(Object.assign({},e),{myCards:a,selectedCards:[]})}))}isMyTurn(t){var s,a;return(null===(s=t.sharedGameState)||void 0===s?void 0:s.status)===e.AWAIT_PLAYER_ACTION&&(null===(a=t.sharedGameState)||void 0===a?void 0:a.currentPlayerId)===t.playerId}updatePassBtn(e){var t,s;this.isMyTurn(e)?null===(t=this.passBtn)||void 0===t||t.removeAttribute("disabled"):null===(s=this.passBtn)||void 0===s||s.setAttribute("disabled","true")}updateMakeMoveBtn(e){var t,s,a,n;const r=null!==(s=null===(t=e.selectedCards)||void 0===t?void 0:t.length)&&void 0!==s?s:0;this.isMyTurn(e)&&r>0?null===(a=this.makeMoveBtn)||void 0===a||a.removeAttribute("disabled"):null===(n=this.makeMoveBtn)||void 0===n||n.setAttribute("disabled","true")}update(e){this.updatePassBtn(e),this.updateMakeMoveBtn(e)}}(o,h);o.subscribe(g)})();